def newTag

pipeline {
    agent any

    environment {
        DB_USER = "$DB_USER"
        DB_HOST = "$DB_HOST"
        DB_DATABASE = "$DB_DATABASE"
        DB_PASSWORD = "$DB_PASSWORD"
        DB_PORT = "$DB_PORT"
  }
    
    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/develop']],
                    userRemoteConfigs: [[
                        url: 'git@github.com:LucasKoritar23/test-verse.git',
                        credentialsId: 'ssh-key-github'
                    ]]
                ])
            }
        }

        stage('Start Notify') {
            steps {
                sh '''
                        curl -X POST -H "Content-Type: application/json" -d '{
                            "username": "'${JOB_NAME}'",
                            "avatar_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Jenkins_logo.svg/1200px-Jenkins_logo.svg.png",
                            "embeds": [{
                                "title": "Build Report",
                                "description": "Starting Build ⏳",
                                "color": 16776960,
                                "footer": {
                                    "text": "test-verse API"
                                },
                                "fields": [
                                    {
                                        "name": "Pipeline Name",
                                        "value": "'${JOB_NAME}'"
                                    },
                                    {
                                        "name": "Build ID",
                                        "value": "'${BUILD_ID}'"
                                    },
                                    {
                                        "name": "Pipeline URL",
                                        "value": "'${BUILD_URL}'"
                                    }
                                ]
                            }]
                        }' "$DISCORD_WEBHOOK_URL"
                    '''
            }
        }
        
        stage('Check Docker and docker-compose') {
            steps {
                script {
                    sh 'docker -v'
                    sh 'docker-compose -v'
                }
            }
        }

        stage('Check NodeJS and NPM') {
            steps {
                script {
                    sh 'node -v'
                    sh 'npm -v'
                }
            }
        }

        stage('Check Files') {
            steps {
                script {
                    sh 'ls -la'
                    sh 'pwd'
                }
            }
        }

        // stage('Build Docker Application') {
        //     steps {
        //         script {
        //             // sh 'docker build -t test-verse:${BUILD_ID} .'
        //             // Incremento da tag
        //             // Função para obter a última tag do Docker Hub, implemente conforme a sua necessidade

        //             def currentTag = getLatestTagFromDockerHub("$DOCKERHUB_USERNAME/test-verse")
        //             newTag = incrementTag(currentTag)
                
        //             // Realiza o build da imagem com a nova tag
        //             sh "docker build -t $DOCKERHUB_USERNAME/test-verse:${newTag} ."
        //         }
        //     }
        // }

        // stage('Publish') {
        //     steps {
        //         sh "echo $DOCKERHUB_PASSWORD | docker login --username $DOCKERHUB_USERNAME --password-stdin"
        //         // Faz upload da imagem para o Docker Hub com a nova tag
        //         sh "docker push $DOCKERHUB_USERNAME/test-verse:${newTag}"
        //     }
        // }

        stage('Obter última tag') {
            steps {
                script {
                    def dockerHubAuth = "https://hub.docker.com/v2/users/login"
                    def payload = [
                        key1: "$DOCKERHUB_USERNAME",
                        key2: "$DOCKERHUB_PASSWORD"
                    ]
                    
                    def response = httpRequest httpMode: 'POST', url: dockerHubAuth, contentType: 'APPLICATION_JSON', requestBody: groovy.json.JsonOutput.toJson(payload)
                    def json = readJSON text: response.content
                    def token = json.results[0].token

                    echo "Token: ${token}"

                    def dockerHubUrl = "https://hub.docker.com/v2/repositories/$DOCKERHUB_USERNAME/test-verse/tags/?ordering=last_updated"
                    
                    def headers = [
                        'Content-Type': 'application/json',
                        'Authorization': "Bearer ${token}"
                    ]

                    def response = httpRequest(url: dockerHubUrl, httpMode: 'GET', headers: headers)
                    def json = readJSON text: response.content
                    def latestTag = json.results[0].name
                    
                    // A partir daqui, você pode usar a variável 'latestTag' para fazer o incremento
                    // ou qualquer outra manipulação necessária
                    // Por exemplo, você pode extrair o número da versão da tag e incrementá-lo
                    def versionNumber = latestTag.replaceAll(/[^0-9.]/, '')
                    def incrementedVersion = incrementVersion(versionNumber)
                    
                    echo "Última tag: ${latestTag}"
                    echo "Versão incrementada: ${incrementedVersion}"
                    
                    // Você pode usar a variável 'incrementedVersion' em etapas posteriores do pipeline
                }
            }
        }

                
        // stage('Deploy') {
        //     steps {
        //         // Atualizar a imagem no arquivo docker-compose.yml
        //         script {
        //         def dockerComposeFile = readFile('docker-compose.yml')
        //         dockerComposeFile = dockerComposeFile.replace('test-verse:latest', 'test-verse:${BUILD_ID}')
        //         writeFile file: 'docker-compose.yml', text: dockerComposeFile
        //         }
                
        //         // Executar o deploy usando o Docker Compose
        //         sh 'docker-compose up -d'
        //     }
        // }

        // stage('Pos Deploy DB Scripts') {
        //     steps {
        //         sh 'npm install'
        //         sh 'node /var/jenkins_home/workspace/pipeline-test-verse/db/applyScripts.js'
        //     }
        // }
    }
    
    post {
        success {
            sh '''
                curl -X POST -H "Content-Type: application/json" -d '{
                    "username": "'${JOB_NAME}'",
                    "avatar_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Jenkins_logo.svg/1200px-Jenkins_logo.svg.png",
                    "embeds": [{
                        "title": "Build Report",
                        "description": "Build successful! :white_check_mark:",
                        "color": 65340,
                        "footer": {
                            "text": "test-verse API"
                        },
                        "fields": [
                            {
                                "name": "Pipeline Name",
                                "value": "'${JOB_NAME}'"
                            },
                            {
                                "name": "Build ID",
                                "value": "'${BUILD_ID}'"
                            },
                            {
                                "name": "Pipeline URL",
                                "value": "'${BUILD_URL}'"
                            }
                        ]
                    }]
                }' "$DISCORD_WEBHOOK_URL"
            '''

        }
        
        failure {
            sh '''
                curl -X POST -H "Content-Type: application/json" -d '{
                    "username": "'${JOB_NAME}'",
                    "avatar_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Jenkins_logo.svg/1200px-Jenkins_logo.svg.png",
                    "embeds": [{
                        "title": "Build Report",
                        "description": "Build error! :frowning2:",
                        "color": 16711680,
                        "footer": {
                            "text": "test-verse API"
                        },
                        "fields": [
                            {
                                "name": "Pipeline Name",
                                "value": "'${JOB_NAME}'"
                            },
                            {
                                "name": "Build ID",
                                "value": "'${BUILD_ID}'"
                            },
                            {
                                "name": "Pipeline URL",
                                "value": "'${BUILD_URL}'"
                            }
                        ]
                    }]
                }' "$DISCORD_WEBHOOK_URL"
            '''
        }
    }
}

def incrementTag(currentTag) {
    if (currentTag == null || currentTag.trim().isEmpty()) {
        return '1.0.0'
    }
    
    def parts = currentTag.tokenize('.')
    def major = parts[0].toInteger()
    def minor = parts[1].toInteger()
    def patch = parts[2].toInteger()
    
    patch += 1
    
    def newTag = "${major}.${minor}.${patch}"
    return newTag
}

def getLatestTagFromDockerHub(imageName) {
    sh "docker pull ${imageName}:latest"
    def inspectOutput = sh(script: "docker inspect --format='{{index .RepoDigests 0}}' ${imageName}:latest", returnStdout: true).trim()
    
    // Extract the tag from the RepoDigests output
    def tag = inspectOutput.tokenize('@')[1]
    
    return tag
}